<?php

define('MINT', true);
define('MINT_ROOT', '../../../');
error_reporting(E_ALL);

include(MINT_ROOT.'app/lib/mint.php');
include(MINT_ROOT.'app/lib/pepper.php');
include(MINT_ROOT.'config/db.php');

function queryHostIP($ip_adr) {
	
	$ip_adr_ip = $ip_adr;
	$useCURL = in_array('curl', get_loaded_extensions());
    
    $host     = 'api.hostip.info';
    $gateway  = '/get_html.php';
    $post     =  'ip='.$ip_adr_ip.'&position=true';
    $data = '';
        
    if ($useCURL) {
      //Use cURL
      $handle	 = curl_init();
      curl_setopt($handle, CURLOPT_URL, "http://{$host}{$gateway}");
      curl_setopt($handle, CURLOPT_CONNECTTIMEOUT, 4);
      curl_setopt($handle, CURLOPT_RETURNTRANSFER, 1);
      
      curl_setopt($handle, CURLOPT_POST, true);
      curl_setopt($handle, CURLOPT_POSTFIELDS, $post);
      
      $data = curl_exec($handle);
      if (curl_errno($handle)) {
		$error = 'Could not connect to Gateway (using cURL): '.curl_error($handle);
      }
      curl_close($handle);
    }
    else {
      //Use fopen
      $handle = fopen("http://{$host}{$gateway}?{$post}", 'rb');  // open connection to hostip.info
      
      while (!feof($handle)) {
        $data .= fread($handle, 8192);      // getting the data
      }
      fclose($handle);
    }
        
    $pos = strpos($data, "City:");
    $tmp_string = substr($data, 0, $pos);
    $tmp_string = trim($tmp_string);
    $tmp_string = substr($tmp_string, 9, strlen($tmp_string));
        
    $country = substr($tmp_string, 0, strpos($tmp_string, "("));
    $country = mysql_escape_string($country);
        
    $country_abrv = substr($tmp_string, strpos($tmp_string, "("), strlen($tmp_string));
    $country_abrv = trim($country_abrv, "()");
        
    $tmp_string = substr($data, $pos, strpos($data, "Latitude:") - $pos);
    $city = substr($tmp_string, 5, strlen($tmp_string));
    $city = trim($city);
    $city = mysql_escape_string($city);
        
    $tmp_string = substr($data, strpos($data, "Latitude:"), strlen($data));
    $lat = substr($tmp_string, 9, strpos($tmp_string, "Longitude:") - 9);
    $lat = trim($lat);
        
    $tmp_string = substr($tmp_string, strpos($tmp_string, "Longitude:"), strlen($tmp_string));
    $long = substr($tmp_string, 10, strlen($tmp_string));
    $long = trim($long);
        
    if ($lat == NULL) {                                     // if no geodata is present, set to zero. MAYBE NULL?
      $lat = 0;
    }
        
    if ($long == NULL) {                                    // same here
      $long = 0;
    }

   // $query_hostip = "INSERT INTO {$tbl_Prefix}geo (ip, country, country_abrv, city, latitude, longitude)
                    // VALUES ('$ip_adr', '$country', '$country_abrv', '$city', $lat, $long)"; // storing data in db
        
   // $result_hostip = $this->query($query_hostip);        // do the query, baby!
    return array('country' => $country, 'city' => $city);
}

$ip = $_SERVER['REMOTE_ADDR'];
$host = gethostbyaddr($ip);
$location = queryHostIP($ip);
$location = $location['city'];

$query = mysql_query("SELECT `ip` FROM `{$Mint->db['tblPrefix']}myspace_user` WHERE `ip` = '$ip'");

if (mysql_num_rows($query) > 0) {
	mysql_query("UPDATE `{$Mint->db['tblPrefix']}myspace_hits` SET `last_visit` = '" . time() . "', `hits`=hits+1, `host` = '$host' WHERE `ip` = '$ip'") or die(mysql_error());
}
else {
	mysql_query("INSERT INTO `{$Mint->db['tblPrefix']}myspace_user` (`ip`) VALUES ('$ip')") or die(mysql_error() . ' - ' . __LINE__);
	mysql_query("INSERT INTO `{$Mint->db['tblPrefix']}myspace_hits` (`last_visit`, `host`, `ip`, `location`) VALUES (" . time() . ", '$host', '$ip', '$location')") or die(mysql_error() . ' - ' . __LINE__);
}

mysql_query("INSERT INTO `{$Mint->db['tblPrefix']}myspace_track` (`ip`, `location`, `host`, `time`) VALUES ('$ip', '$location', '$host', " . time() . ")");

?>